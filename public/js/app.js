var socket;angular.module("flapper",["ui.router"]).config(["$urlRouterProvider","$stateProvider",function(t,e){return e.state("home",{url:"/",templateUrl:"/views/posts/index.html",controller:"HomeCtrl",resolve:{postsPromise:["posts",function(t){return t.getAll()}]}}).state("posts",{url:"/posts/{id}",templateUrl:"/views/posts/post.html",controller:"PostsCtrl",resolve:{post:["$stateParams","posts",function(t,e){return e.get(t.id)}]}}),t.otherwise("/")}]).factory("posts",["$http","auth",function(t,e){var o;return o={posts:[]},o.getAll=function(){return t.get("/posts").success(function(t){return angular.copy(t,o.posts)})},o.get=function(e){return t.get("/posts/"+e).then(function(t){return t.data})},o.create=function(n){return t.post("/posts",n,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(t){return o.posts.push(t)})},o.upvote=function(o){return t.put("/posts/"+o._id+"/upvote",null,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(){return o.upvotes++})},o.addComment=function(o,n){return t.post("/posts/"+o+"/comments",n,{headers:{Authorization:"Bearer "+e.getToken()}})},o.upvoteComment=function(o,n){return t.put("/posts/"+o._id+"/comments/"+n._id+"/upvote",null,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(){return n.upvotes++})},o}]).factory("auth",["$http","$window",function(t,e){var o;return o={},o.saveToken=function(t){return e.localStorage["flapper-token"]=t},o.getToken=function(){return e.localStorage["flapper-token"]},o.isLoggedIn=function(){var t,n;return!!(n=o.getToken())&&(t=JSON.parse(e.atob(n.split(".")[1])),t.exp>parseInt(Date.now()/1e3))},o.currentUser=function(){if(o.isLoggedIn())return JSON.parse(e.atob(o.getToken().split(".")[1])).username},o.register=function(e){return t.post("/users/register",e).success(function(t){return o.saveToken(t.token)})},o.login=function(e){return t.post("/users/login",e).success(function(t){return o.saveToken(t.token)})},o.logout=function(){return e.localStorage.removeItem("flapper-token")},o}]).controller("HomeCtrl",["$scope","posts",function(t,e){return t.posts=e.posts,t.addPost=function(){if(t.title)return e.create({title:t.title,link:t.link}),t.title="",t.link=""},t.upvote=function(t){return e.upvote(t)}}]),socket=io();